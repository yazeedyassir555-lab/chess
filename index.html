<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: white; padding: 20px; }
        #myBoard { width: 400px; margin: 20px auto; border: 5px solid #34495e; }
        textarea { width: 400px; height: 60px; margin-bottom: 10px; border-radius: 5px; padding: 10px; }
        button { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 400px; }
        #evaluation { font-weight: bold; color: #f1c40f; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>Ù…Ø­Ù„Ù„ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø°ÙƒÙŠ</h1>
    <textarea id="pgnInput" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ù€ PGN Ù‡Ù†Ø§..."></textarea>
    <button onclick="loadPGN()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</button>
    <div id="myBoard"></div>
    <div class="controls">
        <p>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <span id="evaluation">0.00 | Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ©</span></p>
    </div>

    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· -->
    <script src="jquery.js"></script>
    <script src="chess.js"></script>
    <script src="chessboard-1.0.0.min.js"></script>
    

    <script>
        var board = null;
        var game = new Chess();
        var lastScore = 0.0;

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø­Ù„ÙŠ
       // Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© (v10.0.2) Ù…Ø³ØªÙ‚Ø±Ø© Ø¬Ø¯Ø§Ù‹ ÙˆØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† Ø®Ø§ØµØ©
        var engine = new Worker("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js")
        var lastScore = 0.0;
        engine.postMessage('uci');

        function onDrop (source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            analyzePosition();
        }

        function analyzePosition() {
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 15');
        }

        engine.onmessage = function(event) {
            if (event.data.includes('score cp')) {
                var score = parseInt(event.data.split('score cp ')[1].split(' ')[0]) / 100;
                if (game.turn() === 'b') score = -score;
                
                // Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù‚Ù„Ø© (Blunder, Best Move...)
                var diff = Math.abs(score - lastScore);
                var quality = "Best â­";
                if (diff > 0.3) quality = "Excellent âœ¨";
                if (diff > 0.9) quality = "Inaccuracy ğŸ¤¨";
                if (diff > 2.0) quality = "Mistake âš ï¸";
                if (diff > 4.0) quality = "Blunder âŒ";

                document.getElementById('evaluation').innerHTML = score.toFixed(2) + " | <b>" + quality + "</b>";
                lastScore = score;
            }
        };

        function loadPGN() {
            var pgn = document.getElementById('pgnInput').value;
            if (game.load_pgn(pgn)) {
                board.position(game.fen());
                analyzePosition();
            } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù€ PGN"); }
        }

        board = ChessBoard('myBoard', {
            draggable: true,
            position: 'start',
            pieceTheme: 'img/chesspieces/wikipedia/{piece}.png',
            onDrop: onDrop,
            onSnapEnd: function() { board.position(game.fen()) }
        });
    </script>
</body>
</html>
